FROM node:22-alpine

WORKDIR /app

COPY package*.json ./

RUN npm install --legacy-peer-deps

COPY . .

ARG POSTGRES_HOST
ARG POSTGRES_PORT
ARG POSTGRES_USER
ARG GATEWAY_API_URL
ARG POSTGRES_PASSWORD
ARG POSTGRES_DB
ARG JWT_SECRET
ARG JWT_REFRESH_SECRET
ARG JWT_EXPIRES
ARG REDIS_HOST
ARG REDIS_PORT
ARG REDIS_PASSWORD

ARG PORT

RUN npm run build

ENV \
POSTGRES_HOST=$POSTGRES_HOST \
POSTGRES_PORT=$POSTGRES_PORT \
POSTGRES_USER=$POSTGRES_USER \
GATEWAY_API_URL=$GATEWAY_API_URL \
POSTGRES_PASSWORD=$POSTGRES_PASSWORD \
POSTGRES_DB=$POSTGRES_DB \
JWT_SECRET=$JWT_SECRET \
JWT_REFRESH_SECRET=$JWT_REFRESH_SECRET \
JWT_EXPIRES=$JWT_EXPIRES \
REDIS_HOST=$REDIS_HOST \
REDIS_PORT=$REDIS_PORT \
REDIS_PASSWORD=$REDIS_PASSWORD \
PORT=${PORT}

EXPOSE 5038

USER node

CMD ["node", "dist/main", "--port", "${PORT}"]