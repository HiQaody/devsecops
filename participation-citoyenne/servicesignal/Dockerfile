FROM node:22-alpine

WORKDIR /app

COPY package*.json ./

RUN npm install --legacy-peer-deps

COPY . .

ARG POSTGRES_HOST
ARG POSTGRES_PORT
ARG POSTGRES_USER
ARG EXTERNAL_API_URL
ARG POSTGRES_PASSWORD
ARG POSTGRES_DB

ARG PORT

RUN npm run build

ENV \
POSTGRES_HOST=$POSTGRES_HOST \
POSTGRES_PORT=$POSTGRES_PORT \
POSTGRES_USER=$POSTGRES_USER \
EXTERNAL_API_URL=$EXTERNAL_API_URL \
POSTGRES_PASSWORD=$POSTGRES_PASSWORD \
POSTGRES_DB=$POSTGRES_DB \
PORT=${PORT}

EXPOSE 5002

USER node

CMD ["node", "dist/main", "--port", "${PORT}"]