FROM node:24-alpine

WORKDIR /app

COPY package*.json ./

RUN npm install --legacy-peer-deps

COPY . .

#base de donn√©es
ARG DB_TYPE
ARG POSTGRES_HOST
ARG POSTGRES_PORT
ARG POSTGRES_USER
ARG POSTGRES_PASSWORD
ARG POSTGRES_DB

# Application Configuration
ARG APP_NAME
ARG APP_PORT
# Security
ARG JWT_SECRET
ARG JWT_REFRESH_SECRET
ARG JWT_EXPIRES_IN
# Minio Configuration
ARG MINIO_ENDPOINT
ARG MINIO_PORT
ARG MINIO_ACCESS_KEY
ARG MINIO_SECRET_KEY
ARG MINIO_BUCKET_NAME
# Environment
ARG NODE_ENV
ARG BASE_URL
# Super Admin Configuration (seed)
ARG SUPER_ADMIN_EMAIL
ARG SUPER_ADMIN_PASSWORD
ARG SUPER_ADMIN_PHONE
ARG SUPER_ADMIN_FIRST_NAME
ARG SUPER_ADMIN_LAST_NAME
ARG SUPER_ADMIN_GENDER
ARG SUPER_ADMIN_BIRTH_DATE
ARG SUPER_ADMIN_AVATAR

# Mailer Configuration
ARG MAILER_HOST
ARG MAILER_PORT
ARG MAILER_USER
ARG MAILER_PASS
ARG MAILER_FROM

ARG PORT

RUN npm run build

ENV \
POSTGRES_HOST=${POSTGRES_HOST} \
POSTGRES_PORT=${POSTGRES_PORT} \
POSTGRES_USER=${POSTGRES_USER} \
POSTGRES_PASSWORD=${POSTGRES_PASSWORD} \
POSTGRES_DB=${POSTGRES_DB} \
JWT_SECRET=${JWT_SECRET} \
JWT_REFRESH_SECRET=${JWT_REFRESH_SECRET} \
JWT_EXPIRES_IN=${JWT_EXPIRES_IN} \
MINIO_ENDPOINT=${MINIO_ENDPOINT} \
MINIO_PORT=${MINIO_PORT} \
MINIO_ACCESS_KEY=${MINIO_ACCESS_KEY} \
MINIO_SECRET_KEY=${MINIO_SECRET_KEY} \
MINIO_BUCKET_NAME=${MINIO_BUCKET_NAME} \
NODE_ENV=${NODE_ENV} \
BASE_URL=${BASE_URL} \
SUPER_ADMIN_EMAIL=${SUPER_ADMIN_EMAIL} \
SUPER_ADMIN_PASSWORD=${SUPER_ADMIN_PASSWORD} \
SUPER_ADMIN_PHONE=${SUPER_ADMIN_PHONE} \
SUPER_ADMIN_FIRST_NAME=${SUPER_ADMIN_FIRST_NAME} \
SUPER_ADMIN_LAST_NAME=${SUPER_ADMIN_LAST_NAME} \
SUPER_ADMIN_GENDER=${SUPER_ADMIN_GENDER} \
SUPER_ADMIN_BIRTH_DATE=${SUPER_ADMIN_BIRTH_DATE} \
SUPER_ADMIN_AVATAR=${SUPER_ADMIN_AVATAR} \
MAILER_HOST=${MAILER_HOST} \
MAILER_PORT=${MAILER_PORT} \
MAILER_USER=${MAILER_USER} \
MAILER_PASS=${MAILER_PASS} \
MAILER_FROM=${MAILER_FROM}

EXPOSE 3150

USER node

CMD ["node", "dist/main", "--port", "${PORT}"]