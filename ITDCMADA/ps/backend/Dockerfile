FROM node:24-alpine

WORKDIR /app

COPY package*.json ./

RUN npm install --legacy-peer-deps

COPY . .

ARG DB_HOST
ARG DB_PORT
ARG DB_USER
ARG DB_PASS
ARG DB_NAME

ARG JWT_SECRET
ARG JWT_REFRESH_SECRET
ARG JWT_REFRESH_EXPIRES_IN
ARG JWT_REFRESH_EXPIRES_IN
ARG CORS_ORIGIN
ARG DEBUG
ARG UPLOAD_MAX_SIZE_MB
ARG UPLOAD_DIR

ARG TYPEORM_LOGGING

ARG PORT

ARG RATE_TTL=60
ARG RATE_LIMIT=30
ARG DB_LOGGING=false

# Protocol utilisé par le backend (http ou https)
ARG BACKEND_PROTOCOL

# Pour le frontend (CORS), tu peux aussi préciser http ou https
ARG FRONTEND_ORIGIN


RUN npm run build

ENV \
    DB_HOST=$DB_HOST \
    DB_PORT=$DB_PORT \
    DB_USER=$DB_USER \
    DB_PASS=$DB_PASS \
    DB_NAME=$DB_NAME \
    JWT_SECRET=$JWT_SECRET \
    JWT_REFRESH_SECRET=$JWT_REFRESH_SECRET \
    JWT_REFRESH_EXPIRES_IN=$JWT_REFRESH_EXPIRES_IN \
    JWT_EXPIRES_IN=$JWT_EXPIRES_IN \
    CORS_ORIGIN=$CORS_ORIGIN \
    UPLOAD_MAX_SIZE_MB=$UPLOAD_MAX_SIZE_MB \
    UPLOAD_DIR=$UPLOAD_DIR \
    TYPEORM_LOGGING=$TYPEORM_LOGGING \
    RATE_TTL=$RATE_TTL \
    RATE_LIMIT=$RATE_LIMIT \
    DB_LOGGING=$DB_LOGGING \
    BACKEND_PROTOCOL=$BACKEND_PROTOCOL \
    FRONTEND_ORIGIN=$FRONTEND_ORIGIN \
    PORT=${PORT}

EXPOSE 3152

USER node

CMD ["node", "dist/main", "--port", "${PORT}"]