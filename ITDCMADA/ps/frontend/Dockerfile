FROM node:24-alpine

WORKDIR /app

COPY package*.json ./

RUN npm install --legacy-peer-deps

COPY . .

ARG POSTGRES_HOST
ARG POSTGRES_PORT
ARG POSTGRES_USER
ARG GATEWAY_API_URL
ARG POSTGRES_PASSWORD
ARG POSTGRES_DB
ARG JWT_SECRET
ARG JWT_REFRESH_SECRET
ARG JWT_EXPIRES_IN
ARG MINIO_ENDPOINT
ARG MINIO_PORT
ARG MINIO_ACCESS_KEY
ARG MINIO_SECRET_KEY
ARG MINIO_BUCKET_NAME
ARG NODE_ENV
ARG BASE_URL
ARG SUPER_ADMIN_EMAIL
ARG SUPER_ADMIN_PASSWORD

ARG PORT

RUN npm run build

ENV \
POSTGRES_HOST=$POSTGRES_HOST \
POSTGRES_PORT=$POSTGRES_PORT \
POSTGRES_USER=$POSTGRES_USER \
GATEWAY_API_URL=$GATEWAY_API_URL \
POSTGRES_PASSWORD=$POSTGRES_PASSWORD \
POSTGRES_DB=$POSTGRES_DB \
JWT_SECRET=$JWT_SECRET \
JWT_REFRESH_SECRET=$JWT_REFRESH_SECRET \
JWT_EXPIRES_IN=$JWT_EXPIRES_IN \
MINIO_ENDPOINT=$MINIO_ENDPOINT \
MINIO_PORT=$MINIO_PORT \
MINIO_ACCESS_KEY=$MINIO_ACCESS_KEY \
MINIO_SECRET_KEY=$MINIO_SECRET_KEY \
MINIO_BUCKET_NAME=$MINIO_BUCKET_NAME \
NODE_ENV=$NODE_ENV \
BASE_URL=$BASE_URL \
SUPER_ADMIN_EMAIL=$SUPER_ADMIN_EMAIL \
SUPER_ADMIN_PASSWORD=$SUPER_ADMIN_PASSWORD \
PORT=${PORT}

EXPOSE 3150

USER node

CMD ["node", "dist/main", "--port", "${PORT}"]