FROM node:22-slim

WORKDIR /app

COPY package*.json ./

RUN npm install --legacy-peer-deps

COPY . .

ARG EMAIL_USER
ARG EMAIL_PASS
ARG MINIO_ENDPOINT
ARG MINIO_PORT
ARG MINIO_BUCKET
ARG MINIO_ROOT_USER
ARG MINIO_ROOT_PASSWORD
ARG CLERK_PUBLISHABLE_KEY
ARG CLERK_SECRET_KEY
ARG CLERK_ISSUER
ARG CLERK_JWKS_URL
ARG DATABASE_URL
ARG PORT

RUN npm run build

ENV \
  EMAIL_USER=${EMAIL_USER} \
  EMAIL_PASS=${EMAIL_PASS} \
  MINIO_ENDPOINT=${MINIO_ENDPOINT} \
  MINIO_PORT=${MINIO_PORT} \
  MINIO_BUCKET=${MINIO_BUCKET} \
  MINIO_ROOT_USER=${MINIO_ROOT_USER} \
  MINIO_ROOT_PASSWORD=${MINIO_ROOT_PASSWORD} \
  CLERK_PUBLISHABLE_KEY=${CLERK_PUBLISHABLE_KEY} \
  CLERK_SECRET_KEY=${CLERK_SECRET_KEY} \
  CLERK_ISSUER=${CLERK_ISSUER} \
  CLERK_JWKS_URL=${CLERK_JWKS_URL} \
  DATABASE_URL=${DATABASE_URL} \
  PORT=${PORT}

EXPOSE 3145

USER node

CMD ["node", "dist/main.js", "--port", "${PORT}"]